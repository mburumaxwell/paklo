# This workflow is copied/inspired by
# https://github.com/github/dependabot-action/blob/8c7db1256e8ad995808c2380bfff7b578b54bf16/.github/workflows/dependabot-build.yml

name: Update container manifest

on:
  # Not using `pull_request` here to get around the limitations of accessing secrets
  # in a pull_request event triggered by a bot.
  # Security: pull_request_target is safe here because:
  # 1. Only runs for dependabot[bot] actor (checked in job condition)
  # 2. Dependabot PRs are trusted (created by GitHub's infrastructure)
  # 3. Only executes our own maintenance scripts, not arbitrary PR code
  pull_request_target:

permissions:
  pull-requests: write
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependabot-metadata:
    name: Dependabot Metadata
    runs-on: ubuntu-latest
    # We only want to check the metadata on pull_request events from Dependabot itself,
    # any subsequent pushes to the PR should just skip this step so we don't go into
    # a loop on commits created by the `update-files` job
    if: ${{ github.actor == 'dependabot[bot]' }}
    # Map the step output to a job output for subsequent jobs
    outputs:
      dependency-type: ${{ steps.dependabot-metadata.outputs.dependency-type }}
      package-ecosystem: ${{ steps.dependabot-metadata.outputs.package-ecosystem }}
    steps:
      - name: Fetch dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@v2.5.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

  update-files:
    name: Update Files
    runs-on: ubuntu-latest
    needs: [dependabot-metadata]
    # We only need to update the manifest if the PR relates to Docker
    if: needs.dependabot-metadata.outputs.package-ecosystem == 'docker'
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v2.2.1
        with:
          app-id: ${{ secrets.GH_APP_ID_RELEASER }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY_RELEASER }}

      - uses: actions/checkout@v6
        with:
          submodules: true
          # fixes detached head state on Dependabot PRs
          ref: ${{ github.event.pull_request.head.ref }}
          # Check out using the generated token so any pushed changes will trigger check runs
          token: ${{ steps.generate_token.outputs.token }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup node
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Setup turborepo caching
        uses: rharkor/caching-for-turbo@v2.3.11

      - name: Download deps
        run: pnpm install
        working-directory: '${{ github.workspace }}/packages/runner'

      # Change git info to match the token
      - name: Setup git info
        run: |
          # Specifying the full email allows the avatar to show up: https://github.com/orgs/community/discussions/26560
          git config user.name "release-automator-mburumaxwell[bot]"
          git config user.email "214517399+release-automator-mburumaxwell[bot]@users.noreply.github.com"

      - name: Rebuild docker/containers.json
        if: needs.dependabot-metadata.outputs.package-ecosystem == 'docker'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          pnpm scripts:update-container-manifest

          # Check if containers.json actually changed
          if git diff --exit-code docker/containers.json > /dev/null; then
            echo "No changes to containers.json"
            exit 0
          fi

          echo "Changes detected in containers.json, creating changeset..."

          # Create changeset file with timestamp-based unique name
          CHANGESET_ID="docker-manifest-$(date +%s)"
          cat > ../../.changeset/${CHANGESET_ID}.md << EOF
          ---
          "@paklo/runner": patch
          ---

          Updated docker container manifest for ${PR_TITLE}
          EOF

          # Stage both files
          git add docker/containers.json ../../.changeset/${CHANGESET_ID}.md
          git commit -m "[dependabot skip] Update container manifest and changeset"
        working-directory: '${{ github.workspace }}/packages/runner'

      - name: Push staged changes
        run: |
          git push
